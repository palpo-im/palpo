# 实施计划: Palpo Web配置管理

## 概述

本实施计划将Palpo Matrix服务器web配置管理界面分解为增量开发的任务。项目采用Rust + Salvo后端和Dioxus前端的全栈Rust架构，提供现代化的配置管理体验。

技术栈：
- 后端：Rust + Salvo web框架 + PostgreSQL + Diesel ORM
- 前端：Dioxus (Rust WebAssembly框架) + TailwindCSS
- 测试：单元测试 + 集成测试 + 属性测试

## 任务

- [ ] 1. 项目设置和基础架构
  - [ ] 1.1 创建项目结构和配置文件
    - 设置Cargo.toml，包含后端和前端依赖
    - 创建Dioxus.toml配置文件
    - 设置TailwindCSS配置和构建脚本
    - 创建项目目录结构（src/api/, src/web/, assets/等）
    - _需求: 所有需求的基础设施_

  - [ ]* 1.2 验证项目设置完整性
    - 验证所有必需的配置文件已创建（Cargo.toml, Dioxus.toml, tailwind.config.js）
    - 验证项目目录结构完整（src/api/, src/web/, assets/等）
    - 验证依赖项正确配置（后端和前端依赖）
    - 验证构建脚本可执行（dev.sh, build.sh）
    - _验证: 基础设施需求_
    - 注意：需要先完成任务1.1；这是验证检查清单，不是自动化测试

  - [x] 1.3 设置开发和构建工具链
    - 安装和配置Dioxus CLI
    - 创建开发脚本（dev.sh）和构建脚本（build.sh）
    - 配置热重载和WASM优化设置
    - _需求: 开发效率基础_

- [ ] 2. 核心数据模型和错误处理
  - [x] 2.1 实现配置数据模型
    - 创建ServerConfigSection、DatabaseConfigSection等配置结构体
    - 实现serde序列化和反序列化
    - 定义配置验证规则和约束
    - _需求: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1_

  - [ ]* 2.2 编写配置模型属性测试
    - **属性 2: 配置持久化轮回**
    - **验证: 需求 10.1, 10.2, 10.3, 10.4**
    - 注意：需要先完成任务2.1；测试配置序列化、保存、加载、反序列化的完整流程

  - [x] 2.3 实现错误处理系统
    - 定义WebConfigError错误类型
    - 实现错误转换和HTTP状态码映射
    - 创建前端ApiError类型和错误处理钩子
    - _需求: 8.1, 8.2, 8.4_

  - [ ]* 2.4 编写错误处理单元测试
    - 测试错误类型转换和状态码映射
    - 测试前端错误处理逻辑（非UI组件部分）
    - _需求: 8.1, 8.2, 8.4_
    - 注意：需要先完成任务2.3；前端部分仅测试业务逻辑函数

- [ ] 3. 认证和授权中间件
  - [x] 3.1 实现认证中间件
    - 创建AuthMiddleware结构体
    - 实现JWT令牌验证和管理员权限检查
    - 实现会话管理和超时处理
    - _需求: 9.1, 9.2, 9.3, 9.5_

  - [ ]* 3.2 编写认证属性测试
    - **属性 4: 认证和授权一致性**
    - **验证: 需求 9.1, 9.2, 9.4, 9.5**
    - 注意：需要先完成任务3.1；测试JWT验证、权限检查、会话管理等后端逻辑

  - [x] 3.3 实现审计日志系统
    - 创建AuditLogEntry数据模型
    - 实现审计日志记录中间件
    - 创建审计日志查询和管理API
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ]* 3.4 编写审计日志属性测试
    - **属性 6: 审计日志完整性**
    - **验证: 需求 12.1, 12.2, 12.3, 12.4**
    - 注意：需要先完成任务3.3；测试日志记录、查询、完整性验证等

- [ ] 4. 配置管理API实现
  - [x] 4.1 实现配置API核心功能
    - 创建ConfigAPI结构体和路由处理器
    - 实现get_config、update_config、validate_config方法
    - 实现配置文件读写和TOML序列化
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 8.1, 8.2, 8.3, 8.5, 10.1_

  - [ ]* 4.2 编写配置验证属性测试
    - **属性 1: 配置验证一致性**
    - **验证: 需求 1.2, 1.4, 2.1, 2.2, 2.4, 8.1, 8.2**
    - 注意：需要先完成任务4.1；测试配置验证逻辑的一致性和准确性

  - [ ]* 4.3 编写配置依赖验证属性测试
    - **属性 5: 配置依赖验证**
    - **验证: 需求 8.3, 8.4**
    - 注意：需要先完成任务4.1；测试配置项之间的依赖关系验证

  - [x] 4.4 实现配置模板API
    - 创建ConfigTemplateAPI和相关数据模型
    - 实现模板的创建、应用、验证功能
    - 提供内置的开发、生产、测试环境模板
    - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

  - [ ]* 4.5 编写配置模板单元测试
    - 测试模板创建和应用逻辑
    - 测试模板验证和冲突处理
    - _需求: 14.1, 14.2, 14.3, 14.4_
    - 注意：需要先完成任务4.4；测试模板API的核心功能

  - [x] 4.6 实现配置导入导出API
    - 创建ConfigImportExportAPI
    - 实现多格式导出（TOML、JSON、YAML）
    - 实现导入预览和冲突解决
    - _需求: 21.1, 21.2, 21.3, 21.4, 21.5_

  - [ ]* 4.7 编写导入导出属性测试
    - **属性 7: 配置导入导出轮回**
    - **验证: 需求 14.1, 14.2, 14.3, 14.4**
    - 注意：需要先完成任务4.6；测试导出→导入→验证的完整流程

- [x] 5. 检查点 - 配置管理核心功能
  - 确保所有配置API测试通过，询问用户是否有问题

- [ ] 6. 用户管理API实现
  - [x] 6.1 实现用户管理API
    - 创建UserAdminAPI和相关数据模型
    - 实现用户列表、创建、更新、停用功能
    - 实现密码重置和管理员权限管理
    - _需求: 16.1, 16.2, 16.3, 16.4, 16.5_

  - [ ]* 6.2 编写用户管理单元测试
    - 测试用户CRUD操作
    - 测试批量操作和权限检查
    - _需求: 16.1, 16.2, 16.3, 16.4, 16.5_
    - 注意：需要先完成任务6.1；测试用户管理API的核心功能

- [ ] 7. 房间管理API实现
  - [x] 7.1 实现房间管理API
    - 创建RoomAdminAPI和相关数据模型
    - 实现房间列表、详情查看、启用/禁用功能
    - 实现强制用户加入/离开房间功能
    - _需求: 17.1, 17.2, 17.3, 17.4, 17.5_

  - [ ]* 7.2 编写房间管理单元测试
    - 测试房间管理操作
    - 测试房间权限和标签管理
    - _需求: 17.1, 17.2, 17.3, 17.4, 17.5_
    - 注意：需要先完成任务7.1；测试房间管理API的核心功能

- [ ] 8. 联邦管理API实现
  - [x] 8.1 实现联邦管理API
    - 创建FederationAdminAPI和相关数据模型
    - 实现联邦服务器列表和连接状态管理
    - 实现联邦测试和支持信息获取
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 18.1, 18.2, 18.3, 18.4, 18.5_

  - [ ]* 8.2 编写联邦管理单元测试
    - 测试联邦连接管理
    - 测试服务器信息获取和验证
    - _需求: 18.1, 18.2, 18.3, 18.4, 18.5_

- [ ] 9. 媒体管理API实现
  - [x] 9.1 实现媒体管理API
    - 创建MediaAdminAPI和相关数据模型
    - 实现媒体文件统计、查询、删除功能
    - 实现批量删除和过期媒体清理
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 20.1, 20.2, 20.3, 20.4, 20.5_

  - [ ]* 9.2 编写媒体管理单元测试
    - 测试媒体文件操作
    - 测试批量删除和清理逻辑
    - _需求: 20.1, 20.2, 20.3, 20.4, 20.5_

- [ ] 10. Appservice管理API实现
  - [x] 10.1 实现Appservice管理API
    - 创建AppserviceAdminAPI和相关数据模型
    - 实现Appservice注册、注销、测试功能
    - 实现YAML配置验证和解析
    - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

  - [ ]* 10.2 编写Appservice管理单元测试
    - 测试Appservice CRUD操作
    - 测试YAML配置验证
    - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

- [ ] 11. 服务器控制API实现
  - [x] 11.1 实现服务器控制API
    - 创建ServerControlAPI和相关数据模型
    - 实现服务器状态查询、配置重载、重启功能
    - 实现管理命令执行和通知发送
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5, 19.1, 19.2, 19.3, 19.4, 19.5, 22.1, 22.2, 22.3, 22.4, 22.5_

  - [ ]* 11.2 编写服务器控制属性测试
    - **属性 11: 热重载功能检测**
    - **验证: 需求 11.5**

  - [ ]* 11.3 编写服务器控制单元测试
    - 测试服务器状态查询
    - 测试命令执行和安全检查
    - _需求: 19.1, 19.2, 19.3, 19.4, 19.5, 22.1, 22.2, 22.3, 22.4, 22.5_

- [x] 12. 检查点 - 后端API完成
  - 确保所有后端API测试通过，询问用户是否有问题

- [ ] 13. Dioxus前端基础架构
  - [x] 13.1 设置Dioxus应用结构
    - 创建主应用组件和路由配置
    - 实现认证路由保护和导航
    - 设置全局状态管理（AuthState、ConfigState）
    - _需求: 9.1, 9.2, 9.3, 13.1_

  - [ ]* 13.2 编写前端状态管理单元测试
    - 测试AuthState和ConfigState逻辑（非UI组件）
    - 测试状态更新和持久化逻辑
    - _需求: 9.1, 9.2, 9.3_
    - 注意：仅测试状态管理逻辑，不测试Dioxus组件

  - [x] 13.3 实现API客户端服务
    - 创建WASM兼容的API客户端
    - 实现请求拦截器和错误处理
    - 实现令牌管理和自动刷新
    - _需求: 9.1, 9.2, 8.1, 8.2_

  - [ ]* 13.4 编写API客户端单元测试
    - 测试API调用逻辑（使用mock）
    - 测试错误处理逻辑
    - 测试令牌管理逻辑
    - _需求: 9.1, 9.2, 8.1, 8.2_
    - 注意：使用mock测试，不依赖实际网络请求

- [ ] 14. 核心UI组件实现
  - [x] 14.1 实现通用UI组件
    - 创建表单组件（输入框、选择器、按钮）
    - 实现错误消息和验证反馈组件
    - 创建加载指示器和进度条组件
    - _需求: 13.4, 13.5, 8.2_

  - [x] 14.2 UI组件测试评估（无法实现）
    - 评估了Dioxus组件单元测试的技术可行性
    - 结论：由于Dioxus组件需要完整运行时环境（DOM、事件系统、框架运行时），无法编写有价值的单元测试
    - 简单的逻辑测试（如字符串拼接、布尔判断）无法验证组件的实际行为（渲染、交互、生命周期）
    - 已创建文档说明技术限制和替代方案（手动测试 + 未来E2E测试）
    - _需求: 13.4, 13.5, 8.2 - 需要通过手动测试或E2E测试验证_

  - [x] 14.3 实现布局和导航组件
    - 禁止生成对实际功能没有价值的测试代码
    - 创建管理界面布局（侧边栏、主内容区）
    - 实现响应式导航菜单
    - 创建面包屑导航和页面标题
    - _需求: 13.1, 13.2_

  - [x]* 14.4 布局组件测试评估（不适用）
    - 与14.2相同原因：Dioxus UI组件无法进行有价值的单元测试
    - 布局和导航功能需要完整的浏览器环境和DOM才能验证
    - 响应式布局测试需要实际的窗口大小调整和CSS媒体查询
    - 导航功能测试需要路由系统和浏览器历史API
    - 推荐通过手动测试验证（参考 TESTING_GUIDE.md）
    - _需求: 13.1, 13.2 - 需要通过手动测试或E2E测试验证_‘/；：：：：：：

- [ ] 15. 配置管理前端页面
  - [x] 15.1 实现配置表单页面
    - 创建分组的配置表单（服务器、数据库、联邦等）
    - 实现实时验证和错误提示
    - 实现配置保存和重置功能
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5, 7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 15.2 添加配置搜索和过滤功能
    - 在配置页面添加搜索输入框
    - 实现配置项名称和描述的模糊搜索
    - 实现按配置节过滤功能
    - 实现搜索结果高亮显示
    - _需求: 13.2_

  - [ ]* 15.3 编写配置搜索过滤属性测试
    - **属性 8: 搜索和过滤准确性**
    - **验证: 需求 13.2**
    - 注意：需要先完成任务 15.2

  - [ ]* 15.4 编写配置表单属性测试
    - **属性 9: 操作反馈一致性**
    - **验证: 需求 13.5**
    - 测试保存成功/失败反馈
    - 测试验证错误反馈

  - [ ] 15.5 实现配置模板页面
    - 创建模板选择和应用界面
    - 实现模板创建和编辑功能
    - 实现模板预览和差异对比
    - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

  - [ ]* 15.6 编写配置模板单元测试
    - 测试模板选择和应用流程
    - 测试模板编辑和验证
    - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_
    - 注意：需要先完成任务 15.5

  - [ ] 15.7 实现配置导入导出页面
    - 创建配置导出界面（格式选择、选项配置）
    - 实现配置导入界面（文件上传、预览、冲突解决）
    - 实现导入导出历史记录
    - _需求: 21.1, 21.2, 21.3, 21.4, 21.5_

  - [ ]* 15.8 编写导入导出属性测试
    - **属性 10: 敏感信息安全处理**
    - **验证: 需求 14.5**
    - 注意：需要先完成任务 15.7

- [ ] 16. 用户管理前端页面
  - [ ] 16.1 实现用户列表页面
    - 创建用户列表和搜索过滤功能
    - 实现用户详情查看和编辑
    - 实现批量操作（停用、权限设置）
    - _需求: 16.1, 16.2, 16.3, 16.4, 16.5_

  - [ ]* 16.2 编写用户管理业务逻辑测试
    - 测试用户搜索和过滤逻辑（非UI组件）
    - 测试批量操作逻辑
    - 测试用户数据验证逻辑
    - _需求: 16.1, 16.2, 16.3, 16.4, 16.5_
    - 注意：仅测试业务逻辑函数，不测试Dioxus组件

- [ ] 17. 房间管理前端页面
  - [ ] 17.1 实现房间管理页面
    - 创建房间列表和详情查看
    - 实现房间启用/禁用和权限管理
    - 实现房间成员管理和强制操作
    - _需求: 17.1, 17.2, 17.3, 17.4, 17.5_

  - [ ]* 17.2 编写房间管理业务逻辑测试
    - 测试房间列表过滤逻辑（非UI组件）
    - 测试房间权限验证逻辑
    - 测试成员管理逻辑
    - _需求: 17.1, 17.2, 17.3, 17.4, 17.5_
    - 注意：仅测试业务逻辑函数，不测试Dioxus组件

- [ ] 18. 联邦管理前端页面
  - [ ] 18.1 实现联邦管理页面
    - 创建联邦服务器列表和状态显示
    - 实现联邦连接测试和诊断
    - 实现联邦配置和白名单管理
    - _需求: 18.1, 18.2, 18.3, 18.4, 18.5_

  - [ ]* 18.2 编写联邦管理业务逻辑测试
    - 测试联邦服务器状态解析逻辑（非UI组件）
    - 测试连接测试结果处理逻辑
    - 测试白名单验证逻辑
    - _需求: 18.1, 18.2, 18.3, 18.4, 18.5_
    - 注意：仅测试业务逻辑函数，不测试Dioxus组件

- [ ] 19. 媒体管理前端页面
  - [ ] 19.1 实现媒体管理页面
    - 创建媒体文件列表和统计显示
    - 实现媒体文件搜索和批量删除
    - 实现过期媒体清理和存储管理
    - _需求: 20.1, 20.2, 20.3, 20.4, 20.5_

  - [ ]* 19.2 编写媒体管理业务逻辑测试
    - 测试媒体文件搜索逻辑（非UI组件）
    - 测试批量删除选择逻辑
    - 测试存储统计计算逻辑
    - _需求: 20.1, 20.2, 20.3, 20.4, 20.5_
    - 注意：仅测试业务逻辑函数，不测试Dioxus组件

- [ ] 20. Appservice管理前端页面
  - [ ] 20.1 实现Appservice管理页面
    - 创建Appservice列表和配置显示
    - 实现Appservice注册和YAML编辑
    - 实现Appservice测试和状态监控
    - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

  - [ ]* 20.2 编写Appservice管理业务逻辑测试
    - 测试YAML配置解析逻辑（非UI组件）
    - 测试Appservice状态验证逻辑
    - 测试配置验证逻辑
    - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_
    - 注意：仅测试业务逻辑函数，不测试Dioxus组件

- [ ] 21. 服务器控制前端页面
  - [ ] 21.1 实现服务器状态页面
    - 创建服务器状态仪表板
    - 实现配置重载和服务器重启功能
    - 实现管理命令执行界面
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5, 19.1, 19.2, 19.3, 19.4, 19.5, 22.1, 22.2, 22.3, 22.4, 22.5_

  - [ ]* 21.2 编写服务器控制业务逻辑测试
    - 测试状态数据解析逻辑（非UI组件）
    - 测试命令验证逻辑
    - 测试安全确认逻辑
    - _需求: 19.1, 19.2, 19.3, 19.4, 19.5, 22.1, 22.2, 22.3, 22.4, 22.5_
    - 注意：仅测试业务逻辑函数，不测试Dioxus组件

- [ ] 22. 审计日志前端页面
  - [ ] 22.1 实现审计日志页面
    - 创建审计日志列表和搜索过滤
    - 实现日志详情查看和导出
    - 实现基于日志的配置回滚功能
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ]* 22.2 编写审计日志属性测试
    - **属性 12: 日志归档管理**
    - **验证: 需求 12.5**
    - 注意：需要先完成任务 22.1

  - [ ]* 22.3 编写审计日志业务逻辑测试
    - 测试日志搜索过滤逻辑（非UI组件）
    - 测试日志导出格式化逻辑
    - 测试配置回滚数据准备逻辑
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_
    - 注意：仅测试业务逻辑函数，不测试Dioxus组件

- [ ] 23. 检查点 - 前端功能完成
  - 确保所有前端页面测试通过，询问用户是否有问题

- [ ] 24. 集成测试和端到端测试
  - [ ] 24.1 实现后端集成测试
    - 创建API集成测试套件
    - 测试数据库操作和文件系统交互
    - 测试认证流程和权限检查
    - _需求: 所有后端API需求_

  - [ ]* 24.2 编写列表管理属性测试
    - **属性 3: 列表管理操作不变性**
    - **验证: 需求 3.2, 3.4, 6.3**
    - 注意：需要先完成后端集成测试基础设施

  - [ ]* 24.3 实现前端集成测试
    - 创建前端业务逻辑集成测试
    - 测试API调用和状态管理集成
    - 测试数据流和错误处理
    - _需求: 所有前端UI需求_
    - 注意：测试业务逻辑集成，不测试UI渲染

  - [ ]* 24.4 编写端到端测试
    - 使用浏览器自动化工具测试完整工作流程
    - 测试跨浏览器兼容性
    - _需求: 13.1, 13.2, 13.3, 13.4, 13.5_
    - 注意：需要配置E2E测试环境（如Playwright或Selenium）

- [ ] 25. 部署和配置优化
  - [ ] 25.1 优化构建配置
    - 配置WASM包大小优化
    - 实现静态资源压缩和缓存
    - 创建生产环境构建脚本
    - _需求: 性能和部署需求_

  - [ ] 25.2 创建部署文档和脚本
    - 编写部署指南和配置说明
    - 创建Docker容器化配置
    - 实现健康检查和监控配置
    - _需求: 运维和维护需求_

- [ ] 26. 最终检查点 - 项目完成
  - 确保所有测试通过，询问用户是否有问题

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证和用户反馈
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
- 集成测试验证组件间交互和端到端流程

## 测试策略说明

### 前端测试分层

由于Dioxus UI组件需要完整的运行时环境（DOM、事件系统、框架运行时），本项目采用以下测试策略：

1. **业务逻辑单元测试**
   - 测试独立的业务逻辑函数（搜索、过滤、验证、数据转换等）
   - 测试状态管理逻辑（非UI组件部分）
   - 测试API客户端逻辑（使用mock）
   - 这些测试不依赖Dioxus运行时，可以作为标准Rust单元测试运行

2. **手动测试**
   - UI组件渲染和交互
   - 响应式布局和样式
   - 用户体验和可访问性
   - 参考 `TESTING_GUIDE.md` 进行系统化手动测试

3. **端到端测试（可选）**
   - 使用浏览器自动化工具（Playwright、Selenium等）
   - 测试完整的用户工作流程
   - 测试跨浏览器兼容性
   - 需要额外的测试基础设施配置

### 后端测试分层

1. **单元测试**
   - 测试独立的函数和模块
   - 测试数据模型的序列化和验证
   - 测试错误处理逻辑

2. **属性测试**
   - 验证通用正确性属性（如配置持久化轮回、认证一致性等）
   - 使用随机生成的测试数据验证系统行为

3. **集成测试**
   - 测试API端点和数据库交互
   - 测试认证流程和权限检查
   - 测试文件系统操作

### 测试任务依赖关系

- 测试任务必须在对应功能实现后才能执行
- 属性测试和单元测试标记为可选（`*`），以加快MVP开发
- 建议在功能稳定后补充测试，确保代码质量

### 已识别的测试问题和解决方案

1. **问题**: 任务15.2原本要求测试搜索功能，但搜索功能未实现
   - **解决**: 添加任务15.2实现搜索功能，将测试移至15.3

2. **问题**: 多个前端测试任务试图测试Dioxus UI组件
   - **解决**: 重新定义为"业务逻辑测试"，明确只测试非UI部分

3. **问题**: 测试任务缺少前置依赖说明
   - **解决**: 为所有测试任务添加"注意"说明，明确依赖关系

4. **问题**: 集成测试和E2E测试缺少环境配置说明
   - **解决**: 添加环境配置要求说明