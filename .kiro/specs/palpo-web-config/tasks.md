# 实施计划: Palpo Web配置管理

## 概述

本实施计划将Palpo Matrix服务器web管理界面分解为增量开发的任务。项目采用Rust + Salvo后端和Dioxus前端的全栈Rust架构，提供现代化的配置和运营管理体验。

技术栈：
- 后端：Rust + Salvo web框架 + PostgreSQL + Diesel ORM
- 前端：Dioxus (Rust WebAssembly框架) + TailwindCSS
- 测试：单元测试 + 集成测试 + 属性测试

## 实施阶段

### 第一阶段：基础架构和UI页面框架
### 第二阶段：用户管理功能
### 第三阶段：房间和媒体管理功能
### 第四阶段：新模块（目录、联邦、令牌、举报、设备）

---

## 阶段一：基础架构和UI页面框架

- [x] 1. 项目设置和基础架构
  - [x] 1.1 验证项目结构和配置文件
    - 验证Cargo.toml、Dioxus.toml、tailwind.config.js配置完整
    - 验证项目目录结构（src/api/, src/web/, assets/等）
    - 验证开发和构建脚本（dev.sh, build.sh）
    - _需求: 所有需求的基础设施_

  - [x] 1.2 设置开发和构建工具链
    - 安装和配置Dioxus CLI
    - 创建开发脚本和构建脚本
    - 配置热重载和WASM优化设置
    - _需求: 开发效率基础_

- [ ] 2. 核心数据模型和错误处理
  - [ ] 2.1 实现配置数据模型
    - 创建ServerConfigSection、DatabaseConfigSection等配置结构体
    - 实现serde序列化和反序列化
    - 定义配置验证规则和约束
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ] 2.2 实现错误处理系统
    - 定义WebConfigError错误类型
    - 实现错误转换和HTTP状态码映射
    - 创建前端ApiError类型和错误处理钩子
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

- [ ] 3. 认证和授权中间件
  - [ ] 3.1 实现认证中间件
    - 创建AuthMiddleware结构体
    - 实现JWT令牌验证和管理员权限检查
    - 实现会话管理和超时处理
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

  - [ ] 3.2 实现审计日志系统
    - 创建AuditLogEntry数据模型
    - 实现审计日志记录中间件
    - 创建审计日志查询和管理API
    - _需求: 操作日志记录_

- [ ] 4. Dioxus前端基础架构
  - [ ] 4.1 设置Dioxus应用结构
    - 创建主应用组件和路由配置
    - 实现认证路由保护和导航
    - 设置全局状态管理（AuthState枚举、AppState）
    - _需求: 11.1, 11.2, 11.3_

  - [ ] 4.2 实现API客户端服务
    - 创建gloo-net + 拦截器模式的API客户端
    - 实现RequestConfig、HttpMethod、TokenManager
    - 实现AuthInterceptor、ErrorInterceptor
    - 实现令牌管理和自动刷新
    - _需求: 10.1, 10.2, 10.4_

- [ ] 5. 通用UI组件
  - [ ] 5.1 实现通用UI组件
    - 创建表单组件（输入框、选择器、按钮）
    - 实现错误消息和验证反馈组件
    - 创建加载指示器和进度条组件
    - 实现确认对话框组件
    - _需求: 11.4, 11.5, 11.6_

  - [ ] 5.2 实现布局和导航组件
    - 创建管理界面布局（侧边栏、主内容区）
    - 实现响应式导航菜单
    - 创建面包屑导航和页面标题
    - 实现主题切换（深色/浅色模式）
    - _需求: 11.1, 11.7_

- [ ] 6. 配置管理前端页面
  - [ ] 6.1 实现配置表单页面
    - 创建分组的配置表单（服务器、数据库、联邦等）
    - 实现实时验证和错误提示
    - 实现配置保存和重置功能
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ] 6.2 实现配置模板页面
    - 创建模板选择和应用界面
    - 实现模板创建和编辑功能
    - 实现模板预览和差异对比
    - _需求: 配置模板功能_

  - [ ] 6.3 实现配置导入导出页面
    - 创建配置导出界面（格式选择、选项配置）
    - 实现配置导入界面（文件上传、预览、冲突解决）
    - 实现导入导出历史记录
    - _需求: 配置导入导出功能_

- [ ] 7. 用户管理前端页面（占位符→框架）
  - [ ] 7.1 实现用户列表页面框架
    - 创建用户列表组件，支持分页和排序
    - 实现用户搜索和过滤功能
    - 实现批量操作下拉菜单
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.18_

  - [ ] 7.2 实现用户详情页面框架
    - 创建用户详情标签页（基本信息、权限、设备、连接等）
    - 实现用户编辑表单
    - 实现用户锁定/解锁、停用/激活功能
    - _需求: 1.5, 1.6, 1.7, 1.8, 1.9_

- [ ] 8. 房间管理前端页面（占位符→框架）
  - [ ] 8.1 实现房间列表页面框架
    - 创建房间列表组件，支持分页和排序
    - 实现房间搜索和过滤（公开房间、空房间）
    - 实现批量操作下拉菜单
    - _需求: 2.1, 2.2, 2.11_

  - [ ] 8.2 实现房间详情页面框架
    - 创建房间详情标签页（基本信息、成员、状态、媒体等）
    - 实现房间编辑表单
    - 实现房间删除和封禁功能
    - _需求: 2.2, 2.3, 2.4, 2.5, 2.6, 2.10_

- [ ] 9. 媒体管理前端页面（占位符→框架）
  - [ ] 9.1 实现媒体管理页面框架
    - 创建媒体文件列表组件
    - 实现媒体搜索和过滤功能
    - 实现批量删除功能
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ] 9.2 实现用户媒体统计页面框架
    - 创建用户媒体统计列表
    - 实现按用户搜索功能
    - 实现批量操作功能
    - _需求: 8.1, 8.2, 8.3_

- [ ] 10. 联邦管理前端页面（占位符→框架）
  - [ ] 10.1 实现联邦目的地页面框架
    - 创建联邦目的地列表组件
    - 实现目的地搜索功能
    - 实现连接状态显示和重连功能
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 11. Appservice管理前端页面（占位符→框架）
  - [ ] 11.1 实现Appservice管理页面框架
    - 创建Appservice列表组件
    - 实现Appservice注册表单（YAML上传）
    - 实现Appservice测试和状态监控
    - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

- [ ] 12. 服务器控制前端页面（占位符→框架）
  - [ ] 12.1 实现服务器状态页面框架
    - 创建服务器状态仪表板
    - 实现服务器通知显示
    - _需求: 13.1, 13.2, 13.3, 13.4_

  - [ ] 12.2 实现服务器命令页面框架
    - 创建命令列表组件
    - 实现命令执行界面
    - 实现定时命令管理
    - _需求: 14.1, 14.2, 14.3, 14.4_

- [ ] 13. 检查点 - 阶段一完成
  - 所有UI页面框架实现完成
  - 基础架构和认证系统就绪
  - 询问用户是否有问题

---

## 阶段二：用户管理功能

- [ ] 14. 用户管理后端API
  - [ ] 14.1 扩展UserAdminAPI
    - 实现用户名可用性检查
    - 实现用户锁定/解锁功能
    - 实现用户暂停功能（MSC3823）
    - 实现用户数据擦除功能
    - _需求: 1.3, 1.5_

  - [ ] 14.2 实现设备管理API
    - 创建设备管理API（DeviceAdminAPI）
    - 实现设备列表、删除功能
    - _需求: 9.1, 9.2, 9.3_

  - [ ] 14.3 实现连接管理API
    - 创建连接管理API
    - 实现连接信息查询功能
    - _需求: 1.8_

  - [ ] 14.4 实现推pushers管理API
    - 创建pushers管理API
    - 实现pushers列表功能
    - _需求: 1.9_

  - [ ] 14.5 实现成员资格管理API
    - 创建成员资格管理API
    - 实现成员资格列表功能
    - _需求: 1.12_

  - [ ] 14.6 实现速率限制管理API
    - 创建速率限制管理API
    - 实现速率限制配置功能
    - _需求: 1.13_

  - [ ] 14.7 实现实验功能管理API
    - 创建实验功能管理API
    - 实现实验功能配置功能
    - _需求: 1.14_

  - [ ] 14.8 实现账户数据管理API
    - 创建账户数据管理API
    - 实现账户数据查看和编辑功能
    - _需求: 1.15_

  - [ ] 14.9 实现第三方标识管理API
    - 创建第三方标识管理API
    - 实现threepids列表和添加功能
    - _需求: 1.16_

  - [ ] 14.10 实现SSO外部ID管理API
    - 创建SSO外部ID管理API
    - 实现外部ID管理功能
    - _需求: 1.17_

  - [ ] 14.11 实现批量用户注册API
    - 创建批量注册API
    - 实现CSV解析和用户创建
    - 支持第三方标识
    - _需求: 17.1, 17.2, 17.3, 17.4_

- [ ] 15. 用户管理前端功能完善
  - [ ] 15.1 完善用户列表功能
    - 实现用户名可用性实时检查
    - 实现密码生成器
    - 实现批量操作（服务器通知、删除）
    - _需求: 1.3, 1.4, 1.18_

  - [ ] 15.2 完善用户详情功能
    - 实现设备管理标签页
    - 实现连接信息标签页
    - 实现pushers标签页
    - _需求: 1.7, 1.8, 1.9_

  - [ ] 15.3 完善用户高级功能
    - 实现成员资格标签页
    - 实现速率限制配置
    - 实现实验功能配置
    - _需求: 1.12, 1.13, 1.14_

  - [ ] 15.4 完善用户账户数据功能
    - 实现账户数据标签页
    - 实现第三方标识管理
    - 实现SSO外部ID管理
    - _需求: 1.15, 1.16, 1.17_

  - [ ] 15.5 实现批量用户注册页面
    - 创建CSV上传界面
    - 实现导入预览和验证
    - 显示导入结果
    - _需求: 17.1, 17.2, 17.3, 17.4_

- [ ] 16. 检查点 - 阶段二完成
  - 用户管理所有功能实现完成
  - 设备、连接、pushers等功能就绪
  - 批量用户注册功能就绪
  - 询问用户是否有问题

---

## 阶段三：房间和媒体管理功能

- [ ] 17. 房间管理后端API
  - [ ] 17.1 扩展RoomAdminAPI
    - 实现房间状态事件列表
    - 实现房间前沿终点查询
    - 实现房间目录发布/取消发布
    - 实现房间管理员设置
    - _需求: 2.4, 2.6, 2.7, 2.8, 2.9_

  - [ ] 17.2 实现房间媒体API
    - 创建房间媒体API
    - 实现房间媒体列表功能
    - _需求: 2.5_

- [ ] 18. 媒体管理后端API
  - [ ] 18.1 扩展MediaAdminAPI
    - 实现用户媒体统计查询
    - 实现媒体隔离功能
    - 实现媒体保护功能
    - 实现远程媒体清理
    - _需求: 3.1, 3.3, 3.4, 3.5_

  - [ ] 18.2 实现用户媒体API
    - 创建用户媒体API
    - 实现用户媒体列表功能
    - _需求: 3.6_

- [ ] 19. 房间管理前端功能完善
  - [ ] 19.1 完善房间列表功能
    - 实现公开房间和空房间过滤
    - 实现批量发布/取消发布
    - _需求: 2.11, 2.7, 2.8_

  - [ ] 19.2 完善房间详情功能
    - 实现状态事件标签页
    - 实现前沿终点标签页
    - 实现房间媒体标签页
    - 实现房间管理员管理
    - _需求: 2.4, 2.6, 2.5, 2.9_

- [ ] 20. 媒体管理前端功能完善
  - [ ] 20.1 完善媒体管理功能
    - 实现媒体隔离和保护
    - 实现远程媒体清理
    - _需求: 3.3, 3.4, 3.5_

  - [ ] 20.2 完善用户媒体统计功能
    - 实现用户媒体统计列表
    - 实现批量清理功能
    - _需求: 8.1, 8.2, 8.3_

- [ ] 21. 检查点 - 阶段三完成
  - 房间管理所有功能实现完成
  - 媒体管理所有功能实现完成
  - 用户媒体统计功能就绪
  - 询问用户是否有问题

---

## 阶段四：新模块

- [ ] 22. 房间目录管理
  - [ ] 22.1 实现房间目录后端API
    - 创建RoomDirectoryAPI
    - 实现目录房间列表
    - 实现发布/取消发布功能
    - _需求: 4.1, 4.2, 4.3_

  - [ ] 22.2 实现房间目录前端页面
    - 创建房间目录列表页面
    - 实现批量发布/取消发布
    - 实现跳转到房间详情
    - _需求: 4.1, 4.2, 4.3, 4.4_

- [ ] 23. 注册令牌管理
  - [ ] 23.1 实现注册令牌后端API
    - 创建RegistrationTokensAPI
    - 实现令牌CRUD功能
    - 实现令牌生成和验证
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [ ] 23.2 实现注册令牌前端页面
    - 创建注册令牌列表页面
    - 实现令牌创建和编辑
    - 实现过滤功能
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 24. 举报管理
  - [ ] 24.1 实现举报管理后端API
    - 创建ReportsAPI
    - 实现举报列表和详情
    - 实现举报删除功能
    - _需求: 7.1, 7.2, 7.3_

  - [ ] 24.2 实现举报管理前端页面
    - 创建举报列表页面
    - 实现举报详情查看（支持媒体预览）
    - 实现删除功能
    - _需求: 7.1, 7.2, 7.3_

- [ ] 25. 服务器操作
  - [ ] 25.1 实现服务器操作后端API
    - 创建ServerOperationsAPI
    - 实现危险操作确认
    - 实现服务器通知发送
    - 实现服务器重启功能
    - _需求: 18.1, 18.2, 18.3, 18.4_

  - [ ] 25.2 实现服务器操作前端页面
    - 创建服务器操作列表
    - 实现操作确认对话框
    - 实现通知发送界面
    - 实现重启选项
    - _需求: 18.1, 18.2, 18.3, 18.4_

- [ ] 26. 自定义菜单和用户徽章
  - [ ] 26.1 实现自定义菜单功能
    - 创建自定义菜单配置API
    - 实现菜单项动态加载
    - _需求: 16.1_

  - [ ] 26.2 实现联系支持功能
    - 添加联系支持菜单项
    - 实现当前用户信息显示
    - _需求: 16.2, 16.3_

  - [ ] 26.3 实现用户徽章功能
    - 创建用户徽章配置
    - 实现徽章显示
    - _需求: 16.4_

- [ ] 27. 检查点 - 阶段四完成
  - 所有新模块实现完成
  - 服务器操作功能就绪
  - 自定义菜单和徽章功能就绪
  - 询问用户是否有问题

---

## 测试任务

- [ ] 28. 单元测试
  - [ ] 28.1 编写后端API单元测试
    - 测试用户管理API
    - 测试房间管理API
    - 测试媒体管理API
    - _需求: 1.x, 2.x, 3.x_

  - [ ] 28.2 编写前端业务逻辑测试
    - 测试搜索和过滤逻辑
    - 测试数据验证逻辑
    - 测试状态管理逻辑
    - _需求: 11.2, 11.3_

- [ ] 29. 属性测试
  - [ ] 29.1 编写配置验证属性测试
    - **属性 1: 配置验证一致性**
    - 验证配置项之间的依赖关系
    - _需求: 12.x_

  - [ ] 29.2 编写认证属性测试
    - **属性 2: 认证和授权一致性**
    - 验证JWT验证和权限检查
    - _需求: 10.x_

  - [ ] 29.3 编写列表操作属性测试
    - **属性 3: 列表管理操作不变性**
    - 验证列表操作的一致性
    - _需求: 1.2, 2.4, 3.2_

- [ ] 30. 集成测试
  - [ ] 30.1 实现后端集成测试
    - 创建API集成测试套件
    - 测试数据库操作
    - 测试认证流程
    - _需求: 所有后端需求_

  - [ ] 30.2 实现前端集成测试
    - 测试API调用和状态管理
    - 测试数据流和错误处理
    - _需求: 所有前端需求_

- [ ] 31. 端到端测试（可选）
  - [ ] 31.1 编写端到端测试
    - 使用Playwright测试完整工作流程
    - 测试跨浏览器兼容性
    - _需求: 11.1, 11.2, 11.3_

---

## 部署和优化

- [ ] 32. 构建优化
  - [ ] 32.1 优化构建配置
    - 配置WASM包大小优化
    - 实现静态资源压缩和缓存
    - 创建生产环境构建脚本
    - _需求: 性能需求_

  - [ ] 32.2 创建部署文档
    - 编写部署指南
    - 创建Docker容器化配置
    - 实现健康检查配置
    - _需求: 运维需求_

- [ ] 33. 最终检查点
  - 确保所有测试通过
  - 确保所有功能实现完成
  - 项目完成

---

## 注意事项

- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证和用户反馈
- 属性测试验证通用正确性属性
- 单元测试验证具体��例和边界情况
- 集成测试验证组件间交互和端到端流程
- 标记为可选的任务可以跳过以加快MVP开发

## 测试策略说明

### 前端测试分层

由于Dioxus UI组件需要完整的运行时环境，本项目采用以下测试策略：

1. **业务逻辑单元测试**
   - 测试独立的业务逻辑函数（搜索、过滤、验证、数据转换等）
   - 测试状态管理逻辑（非UI组件部分）
   - 测试API客户端逻辑（使用mock）

2. **手动测试**
   - UI组件渲染和交互
   - 响应式布局和样式
   - 用户体验和可访问性

3. **端到端测试（可选）**
   - 使用Playwright或Selenium
   - 测试完整的用户工作流程
   - 测试跨浏览器兼容性

### 后端测试分层

1. **单元测试**
   - 测试独立的函数和模块
   - 测试数据模型的序列化和验证
   - 测试错误处理逻辑

2. **属性测试**
   - 验证通用正确性属性
   - 使用随机生成的测试数据验证系统行为

3. **集成测试**
   - 测试API端点和数据库交互
   - 测试认证流程和权限检查
   - 测试文件系统操作